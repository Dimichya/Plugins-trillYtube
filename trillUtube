// YouTubePlayer.js
// Исправленный модуль трейлеров для Lampa

var YouTubePlayer = {
  init: function(videoId, containerId) {
    this.videoId = videoId;
    this.containerId = containerId;
    this.player = null;
    this.firstPlay = false;
    this.autoStopTimeout = null;
    this.isVideoPlaying = false;
    this.isVideoPause = false;
    this.hideTime = 120000; // 2 min
    this.hideBodyTime = 10000; // 10 sec
    this.enabled = null;
    this.videoData = [];
    this.bindEvents();
  },

  bindEvents: function() {
    var _this = this;
    Lampa.Listener.follow('full', function(e) {
      if (e.type === 'complite') _this.addVideo(e.data.videos);
    });
    Lampa.Listener.follow('activity', function(e) {
      var enabled = Lampa.Controller.enabled();
      if (e.type == 'start') _this.enabled = enabled;
    });
    Navigator.follow('focus', function(event) {
      _this.enabled = Lampa.Controller.enabled();
      var el = event.elem.classList.contains('full-start__button');
      if (_this.firstPlay && _this.enabled.name !== 'full_start') {
        _this.firstPlay = false;
        _this.removePlayer('not in focus');
      }
      if (el) {
        setTimeout(function() {
          if (_this.isVideoPause && _this.player && _this.enabled.name === 'full_start') {
            _this.player.playVideo();
            _this.isVideoPause = false;
          }
          if (!_this.isVideoPlaying && _this.videoId && !Lampa.Player.opened() && !_this.firstPlay && Lampa.Activity.active().activity.render().find('.' + _this.containerId).length === 0 && _this.enabled && _this.enabled.name === 'full_start') {
            _this.removePlayer('new card');
            _this.startPlayer();
          }
        }, 500);
      } else {
        if (["console-tabs", "console-body", "menu", "head", "full_reviews", "full_episodes"].indexOf(_this.enabled.name) === -1) _this.removePlayer('enabled controller - ' + _this.enabled.name);
      }
    });
  },

  addVideo: function(videoData) {
    if (videoData && videoData.results && videoData.results[0]) {
      var index = videoData.results.findIndex(function(video) {
        return ((video.official === false || video.official) && video.iso_639_1 === 'ru') ||
          (video.name.toLowerCase().indexOf('официальный трейлер') !== -1 && video.official === true) ||
          (video.name.toLowerCase().indexOf('трейлер') !== -1) ||
          (video.official || !video.official);
      });
      if (index !== -1) {
        this.videoId = videoData.results[index].key;
      } else this.videoId = null;
      if (videoData.results.length > 1) this.videoData = videoData.results;
    }
  },

  tryPlayNextVideo: function() {
    var officialTrailerIndex = this.videoData.findIndex(function(video) {
      return video.name.toLowerCase().indexOf('официальный') !== -1;
    });
    if (officialTrailerIndex !== -1) {
      this.videoId = this.videoData[officialTrailerIndex].key;
      this.startPlayer();
    } else if (this.videoData.length >= 1) {
      this.videoId = this.videoData[1].key;
      this.startPlayer();
    } else {
      this.removePlayer('video not found');
    }
  },

  startPlayer: function() {
    var self = this;
    var loadYouTubePlayer = function() {
      if (typeof YT === 'undefined' || !YT.Player) {
        setTimeout(loadYouTubePlayer, 100);
        return;
      }
      self.player = new YT.Player(self.containerId, {
        height: (window.innerHeight + 600) * 2,
        width: window.innerWidth * 2,
        playerVars: {
          'controls': 0,
          'showinfo': 0,
          'autohide': 1,
          'modestbranding': 1,
          'autoplay': 1,
          'disablekb': 1,
          'fs': 0,
          'enablejsapi': 1,
          'playsinline': 1,
          'mute': 1,
          'rel': 0,
          'loop': 0,
          'suggestedQuality': 'hd1080',
        },
        videoId: self.videoId,
        events: {
          'onReady': function(event) { self.onPlayerReady(event); },
          'onStateChange': function(event) { self.onPlayerStateChange(event); },
          'onPlaybackQualityChange': function(event) { self.onPlaybackQualityChange(event); },
          'onError': function(event) { self.onPlayerError(event); }
        }
      });
      self.startAutoStopTimer();
    };
    var html = $('<div class="' + this.containerId + '"><div class="player-video__youtube-player" id="' + this.containerId + '"></div></div>');
    var object = $('<div class="' + this.containerId + '"><div class="player-video__youtube-player" id="' + this.containerId + '"></div></div>');
    if (Lampa.Platform.tv() || Lampa.Platform.get() == 'android' || Lampa.Platform.get() == 'noname') $('body').append(object[0]);
    else Lampa.Activity.active().activity.render().find('.full-start-new').prepend(object);
    if (window.YT) loadYouTubePlayer(); else {
      $.getScript('https://www.youtube.com/iframe_api', loadYouTubePlayer);
    }
  },

  onPlayerReady: function(event) {
    var cont = Lampa.Activity.active().activity.render().find('.' + this.containerId).length && Lampa.Activity.active().activity.render().find('.' + this.containerId) || $('body').find('.' + this.containerId);
    $(cont).css({opacity: 1, transition: 'opacity 2s ease-in-out'});
    try {
      this.player.playVideo();
      if (!Lampa.Platform.is('apple')) event.target.unMute();
      this.isVideoPlaying = true;
      this.hidePoster();
    } catch (error) {
      console.log('YouTubePlayer error:', error);
    }
  },

  onPlayerStateChange: function(event) {
    switch (event.data) {
      case YT.PlayerState.PLAYING:
        this.fullScreen();
        break;
      case YT.PlayerState.ENDED:
        this.removePlayer();
        break;
      case YT.PlayerState.BUFFERING:
        event.target.setPlaybackQuality('hd1080');
        break;
      case -1:
        break;
      default:
        break;
    }
  },

  onPlaybackQualityChange: function(event) {
    // Optionally handle quality change
  },

  onPlayerError: function(event) {
    switch (event.data) {
      case 2:
        this.removePlayer(event.data);
        break;
      case 100:
        this.removePlayer(event.data);
        this.tryPlayNextVideo();
        break;
      case 101:
      case 150:
        this.removePlayer(event.data);
        this.tryPlayNextVideo();
        break;
      default:
        this.removePlayer(event.data);
    }
  },

  removePlayer: function(hide) {
    if (this.player) {
      if (typeof hide == 'string' && hide.indexOf('full_descr') >= 0) {
        this.isVideoPause = true;
        if (typeof this.player.pauseVideo === 'function') this.player.pauseVideo();
      } else {
        try {
          if (typeof this.player.destroy === 'function') {
            this.player.destroy();
          }
          $('.' + this.containerId).remove();
          this.fadeOut(false, false, true);
          this.isVideoPlaying = false;
          this.isVideoPause = false;
        } catch (error) {
          console.error('YouTubePlayer destroy error:', error);
        }
        this.player = null;
        this.clearAutoStopTimer();
        if (hide !== 'new card') this.hidePoster();
      }
    } else {
      // Если плеер уже уничтожен, просто убираем контейнер
      $('.' + this.containerId).remove();
      this.isVideoPlaying = false;
      this.isVideoPause = false;
      this.player = null;
      this.clearAutoStopTimer();
    }
  },

  startAutoStopTimer: function() {
    var self = this;
    this.autoStopTimeout = setTimeout(function() {
      self.removePlayer();
    }, self.hideTime);
  },

  clearAutoStopTimer: function() {
    if (this.autoStopTimeout) {
      clearTimeout(this.autoStopTimeout);
      this.autoStopTimeout = null;
    }
  },

  fullScreen: function() {
    var _self = this;
    if (window.innerWidth >= 768 && this.isVideoPlaying) {
      setTimeout(function() {
        if (!_self.isVideoPause) _self.fadeOut(true);
      }, _self.hideBodyTime);
    }
  },

  fadeOut: function(fid, key, rem) {
    var _this = this;
    var element = Lampa.Activity.active().activity.render().find('.full-start-new__body');
    if (!!rem) {
      $('body').toggleClass('card--no-cover', false);
      $(element).css({opacity: 1, transition: 'opacity 1s ease'});
    } else {
      if (element) {
        $(element).css({opacity: fid ? 0 : 1, transition: 'opacity 2s ease'});
        if (this.enabled.name == 'full_start') setTimeout(function() {
          $('body').toggleClass('card--no-cover', true);
          $(element).css({opacity: 0, transition: 'opacity 2s ease'});
        }, !_this.isVideoPause ? _this.hideBodyTime : 3000);
        else $('body').toggleClass('card--no-cover', fid);
        $('body').find('.youtube-trailers').css({
          'z-index': this.enabled.name !== 'full_start' ? -1 : !_this.isVideoPause && fid && !key ? 99 : 9
        });
      }
    }
  },

  hidePoster: function() {
    var _self = this;
    var fullStartNew = Lampa.Activity.active().activity.render().find('.full-start-new');
    if (fullStartNew) {
      var fullPoster = fullStartNew.find('.full-start-new__img.full--poster');
      var hasTrailersPlayer = !!fullStartNew.find('.' + this.containerId).length;
      var updateFullPosterVisibility = function() {
        if (window.innerWidth >= 340 && window.innerWidth <= 480 && window.innerHeight > 480) {
          _self.fullScreen();
          $(fullPoster).css({opacity: hasTrailersPlayer ? '0' : '1', transition: hasTrailersPlayer ? 'opacity 1s ease-in-out' : 'none'});
        } else $(fullPoster).css({opacity:1, transition: 'none'});
      };
      Lampa.Keypad.listener.follow('keydown', function(e) {
        setTimeout(function() {
          _self.fadeOut(false, true);
        }, 100);
      });
      window.addEventListener('touchstart', function(e) {
        if (_self.isVideoPlaying) {
          if (_self.player.isMuted()) _self.player.unMute();
          _self.fadeOut(false, false, true);
          if (_self.isVideoPlaying) $(fullPoster).css({opacity:0, transition: 'none'});
        }
      });
      updateFullPosterVisibility();
      window.addEventListener('resize', updateFullPosterVisibility);
    }
  }
};

function addYouTubePlayer() {
  YouTubePlayer.init('VIDEO_ID', Lampa.Platform.tv() || Lampa.Platform.get() == 'noname' || Lampa.Platform.get() == 'android' ? 'youtube-trailers' : 'trailers-player');
  Lampa.Template.add('modss_style', `<style>/* ...your styles here... */</style>`);
  $('body').append(Lampa.Template.get('modss_style', {}, true));
}

if (window.appready) addYouTubePlayer(); else {
  Lampa.Listener.follow('app', function(e) {
    if (e.type == 'ready') addYouTubePlayer();
  });
}
